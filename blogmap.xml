<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Blog Map"
      description="Display blog posts on a map."
      height="250"
      author="Brian Ngo"
      author_email="briancse+blogmap@gmail.com">
  </ModulePrefs>
  <UserPref name="feedUrl" display_name="Blog's GeoRSS feed URL. Save as empty to reset." />
  <UserPref name="height" display_name="Height in pixels"
      required="true" default_value="250" />
  <Content type="html">
    <![CDATA[
      <style type="text/css">
        .inputBox {
          border-color: #777777 #AAAAAA #AAAAAA #777777;
          border-style: solid;
          border-width: 1px;
          padding: 2px;
          width: 100%;
        }

        .inputBox-hint {
          border-color: #777777 #AAAAAA #AAAAAA #777777;
          border-style: solid;
          border-width: 1px;
          padding: 2px;
          width: 96%;
          color: #999;
          font-style: italic;
        }

        .statusMsg {
          font-size: small;
          color: #333;
          font-style: italic;
        }

        .statusMsg-error {
          font-size: small;
          color: red;
          font-weight: bold;
        }
      </style>
      <div id="instructions" style="display: none; font-size: 14px;">
        <p>
          To display your blog posts on a map, enter your <b>blog's URL</b> below.
          Alternatively, you can also enter your blog's <b>RSS or Atom feed URL</b>.
        </p>
        <input type="text" id="feedUrl" name="feedUrl" class="inputBox-hint"
            value="Example: http://your-blog-url.blogspot.com" />
        <div style="padding: 5px 10px 0 0;">
          <input type="button" id="okButton" name="okButton" value="Fetch my blog!" />
        </div>
        <div id="statusMsg" class="statusMsg"></div>
      </div>
      <div id="map"></div>
      <script type="text/javascript">
        var PREFS = new gadgets.Prefs();
        var MAP = null;
        var WIDTH = gadgets.window.getViewportDimensions().width;
        var HEIGHT = PREFS.getInt('height');
        var FEEDURL = PREFS.getString('feedUrl');
        var XML = null;
        var BLOGSPOT_REGEX = new RegExp('blogspot\.com/?$');

        var inputBoxActivated = false;

        function init() {
          gadgets.window.adjustHeight(HEIGHT);
          var container = document.getElementById('map');
          container.style.height = HEIGHT + 'px';
          container.style.width = WIDTH + 'px';

          if (!FEEDURL) {
            document.getElementById('instructions').style.display = '';
            document.getElementById('feedUrl').onclick = activateInput;

            document.getElementById('okButton').onclick = validateFeedUrl;
          } else {

          }
        }

        function activateInput() {
          if (!inputBoxActivated) {
            document.getElementById('feedUrl').className = 'inputBox';
            document.getElementById('feedUrl').value = '';
            inputBoxActivated = true;
          }
        }

        function validateFeedUrl() {
          document.getElementById('statusMsg').className = 'statusMsg';
          document.getElementById('statusMsg').innerHTML = 'Validating feed...';

          var feedUrl =
              maybeFixUrl(document.getElementById('feedUrl').value);

          var params = {};
          params[gadgets.io.RequestParameters.CONTENT_TYPE] =
              gadgets.io.ContentType.FEED;
          params[gadgets.io.RequestParameters.NUM_ENTRIES] = 1;
          params[gadgets.io.RequestParameters.GET_SUMMARIES] = false;
          gadgets.io.makeRequest(feedUrl, handleValidateFeed, params);
        }

        /**
         * Will attempt to detect a blogspot.com url without the feed suffix
         * (e.g., http://ginternfoodblog.blogspot.com/). If detected, adds
         * the feed suffix ("/feeds/posts/default"). Also, adds an http://
         * protocol if one isn't present.
         */
        function maybeFixUrl(url) {
          // trim whitepsace.
          url = url.replace(/^\s*(\S*(\s+\S+)*)\s*$/, "$1");
          // test blogspot url fix
          if (BLOGSPOT_REGEX.test(url)) {
            if (url[url.length - 1] != '/') {
              url += '/';
            }
            url += 'feeds/posts/default';
          }
          // test http protocol fix
          if (url.indexOf('http://') != 0) {
            url = 'http://' + url;
          } elif (url.indexOf('http://') != 0) {
            url = 'https://' + url;
          }
          return url;
        }

        function handleValidateFeed(response) {
          if (response && response.data && response.data.Entry) {
            var feedUrl = response.data.URL;
            PREFS.set('feedUrl', feedUrl);
            FEEDURL = feedUrl;
            fetchFeed();
          } else {
            document.getElementById('statusMsg').className = 'statusMsg-error';
            document.getElementById('statusMsg').innerHTML =
                'Couldn\'t find feed. Is the URL correct?';
          }
        }

        gadgets.util.registerOnLoadHandler(init);
      </script>
    ]]>
  </Content>
</Module>
